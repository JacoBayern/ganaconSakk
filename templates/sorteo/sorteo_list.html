{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Lista de Sorteos</h1>
        <a href="{% url 'sorteo_create' %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i> Crear Sorteo
        </a>
    </div>

    <!-- Barra de Búsqueda y Filtro -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" action="">
                <div class="row g-3 align-items-center">
                    <div class="col-md-8">
                        <input type="text" class="form-control" name="q" placeholder="Buscar por título o descripción..." value="{{ query }}">
                    </div>
                    <div class="col-md-3">
                        <select name="state" class="form-select">
                            <option value="">Todos los estados</option>
                            {% for state_code, state_name in states %}
                                <option value="{{ state_code }}" {% if state_code == state_filter %}selected{% endif %}>{{ state_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-primary w-100" type="submit">Filtrar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de Sorteos -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Título</th>
                            <th scope="col">Estado</th>
                            <th scope="col">Tickets Vendidos</th>
                            <th scope="col">Progreso</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sorteo in sorteos %}
                        <tr>
                            <td><strong>{{ sorteo.title }}</strong><small class="d-block text-muted">Fecha: {{ sorteo.date_lottery|date:"d/m/Y" }}</small></td>
                            <td><span class="badge {% if sorteo.state == 'A' %}bg-success{% elif sorteo.state == 'F' or sorteo.state == 'V' %}bg-secondary{% else %}bg-warning text-dark{% endif %}">{{ sorteo.get_state_display }}</span></td>
                            <td>{{ sorteo.tickets_solds }} / {{ sorteo.total_tickets }}</td>
                            <td>
                                <div class="progress" style="height: 20px; position: relative; background-color: #e9ecef; font-size: 0.8rem;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ sorteo.percentage_sold }}%;" aria-valuenow="{{ sorteo.percentage_sold }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    <div class="d-flex justify-content-center align-items-center w-100 h-100" style="position: absolute; top: 0; left: 0;">
                                        <strong class="text-dark">{{ sorteo.percentage_sold }}%</strong>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <a href="{% url 'ticket_list' sorteo.id %}" class="btn btn-sm btn-info" title="Ver Tickets"><i class="fas fa-ticket-alt"></i></a>
                                <a href="{% url 'sorteo_edit' sorteo.id %}" class="btn btn-sm btn-warning" title="Editar Sorteo"><i class="fas fa-edit"></i></a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center">No se encontraron sorteos.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Paginación -->
    {% if sorteos.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if sorteos.has_previous %}<li class="page-item"><a class="page-link" href="?page=1{% if query %}&q={{ query }}{% endif %}{% if state_filter %}&state={{ state_filter }}{% endif %}">&laquo; Primera</a></li><li class="page-item"><a class="page-link" href="?page={{ sorteos.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if state_filter %}&state={{ state_filter }}{% endif %}">Anterior</a></li>{% endif %}
            <li class="page-item active" aria-current="page"><span class="page-link">Página {{ sorteos.number }} de {{ sorteos.paginator.num_pages }}</span></li>
            {% if sorteos.has_next %}<li class="page-item"><a class="page-link" href="?page={{ sorteos.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if state_filter %}&state={{ state_filter }}{% endif %}">Siguiente</a></li><li class="page-item"><a class="page-link" href="?page={{ sorteos.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if state_filter %}&state={{ state_filter }}{% endif %}">Última &raquo;</a></li>{% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}
